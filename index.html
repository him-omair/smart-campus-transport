<!DOCTYPE html>
<html lang="ar" class="h-full" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- <script src="/_sdk/element_sdk.js"></script> -->
  <!-- <script src="/_sdk/data_sdk.js"></script> -->
  <style>
    * {
      direction: rtl;
    }
    
    body {
      box-sizing: border-box;
      font-family: 'Almarai', sans-serif;
    }
    
    html, body {
      height: 100%;
    }
    
    ::-webkit-scrollbar {
      width: 4px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: #f97316;
      border-radius: 4px;
    }
    
    .leaflet-container {
      background: #e2e8f0;
    }
    
    .bg-light-theme {
      background: #f8fafc;
    }
    
    .gradient-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(249, 115, 22, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
    }
    
    .btn-amber {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      transition: all 0.3s ease;
    }
    
    .btn-amber:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .floating {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .status-live {
      animation: blink 1.5s ease-in-out infinite;
    }
    
    .view-hidden {
      display: none !important;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-up {
      animation: slideUp 0.4s ease-out forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .bottom-panel {
      height: 40%;
      overflow-y: auto;
    }
    
    .zone-button {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      background: white;
      color: #334155;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: right;
    }
    
    .zone-button:hover {
      border-color: #f97316;
      background: #fff7ed;
    }
    
    .zone-button.active {
      border-color: #f97316;
      background: #ffedd5;
      color: #c2410c;
    }
    
    .input-field {
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 12px;
      color: #1e293b;
      font-family: 'Almarai', sans-serif;
      width: 100%;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 10px rgba(249, 115, 22, 0.2);
    }
    
    .input-field::placeholder {
      color: #94a3b8;
    }
    
    .zone-marker {
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, #f97316, #ea580c);
      border-radius: 50%;
      border: 3px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    .leaflet-tile {
      filter: brightness(0.8);
    }

    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }

    .pulse-marker {
      animation: pulse-ring 2s ease-out infinite;
    }

    .ai-hint {
      background: linear-gradient(145deg, rgba(139,92,246,0.15) 0%, rgba(59,130,246,0.1) 100%);
      border: 1px solid rgba(139,92,246,0.3);
    }

    #qr-reader {
      border: none !important;
    }
    #qr-reader video {
      border-radius: 12px !important;
    }
    #qr-reader__scan_region {
      min-height: 250px;
    }
    #qr-reader__dashboard {
      direction: ltr;
    }
    #qr-reader__dashboard button {
      background: linear-gradient(135deg, #f97316 0%, #ef4444 100%) !important;
      color: white !important;
      border: none !important;
      border-radius: 8px !important;
      padding: 10px 20px !important;
      font-family: 'Almarai', sans-serif !important;
      cursor: pointer !important;
    }
  </style>
</head>
<body class="h-full bg-light-theme text-slate-800 overflow-auto">
  
  <!-- ==================== LOGIN VIEW ==================== -->
  <div id="login-view" class="h-full flex flex-col">
    <div class="relative flex-1 flex flex-col items-center justify-center p-6">
      <!-- Logo -->
      <div class="mb-8 floating">
        <div class="w-24 h-24 mx-auto rounded-2xl bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center" style="box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);">
          <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
          </svg>
        </div>
      </div>
      
      <!-- Title -->
      <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
        Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠ
      </h1>
      <p class="text-slate-500 text-lg mb-8">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ÙˆØµÙ„</p>
      
      <!-- User Type Selection -->
      <div id="login-user-type-selection" class="w-full max-w-md space-y-3 mb-6">
        <p class="text-slate-500 text-sm mb-3">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</p>
        <button onclick="selectLoginUserType('student')" class="w-full py-3 rounded-xl btn-primary text-white font-bold flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Ø·Ø§Ù„Ø¨
        </button>
        <button onclick="selectLoginUserType('car-driver')" class="w-full py-3 rounded-xl btn-secondary text-white font-bold flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
          Ø³Ø§Ø¦Ù‚ Ø³ÙŠØ§Ø±Ø©
        </button>
        <button onclick="selectLoginUserType('bus-driver')" class="w-full py-3 rounded-xl btn-amber text-white font-bold flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-8 4h8m-6 4h4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"></path>
          </svg>
          Ø³Ø§Ø¦Ù‚ Ø­Ø§ÙÙ„Ø©
        </button>
        <button onclick="selectLoginUserType('admin')" class="w-full py-3 rounded-xl bg-slate-200 text-slate-700 font-bold flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          </svg>
          Ø¥Ø¯Ø§Ø±Ø©
        </button>
        <div class="w-full border-t border-slate-200 my-2"></div>
        <button onclick="showView('leaderboard'); initLeaderboard();" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-400 to-amber-500 text-white font-bold flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
          </svg>
          Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†
        </button>
      </div>

      <!-- Login Form -->
      <div id="login-form" class="w-full max-w-md space-y-4 view-hidden">
        <div>
          <label class="block text-slate-500 text-sm mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="login-email" type="email" class="input-field" placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ø¨Ø±ÙŠØ¯ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±">
        </div>

        <button onclick="handleLogin()" class="w-full py-3 rounded-xl btn-primary text-white font-bold text-lg">
          Ø¯Ø®ÙˆÙ„
        </button>

        <button onclick="resetLoginView()" class="w-full py-2 rounded-xl bg-white border border-slate-200 text-slate-500 font-medium text-sm">
          Ø±Ø¬ÙˆØ¹
        </button>

        <div class="relative my-4">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-slate-200"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-slate-50 text-slate-500">Ø£Ù… Ø£Ù†Øª Ø¬Ø¯ÙŠØ¯ØŸ</span>
          </div>
        </div>

        <button onclick="showView('register')" class="w-full py-3 rounded-xl bg-white border border-slate-200 text-slate-500 font-medium">
          Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
      
      <!-- University Logo -->
      <div class="mt-12 text-center">
        <div class="w-16 h-16 mx-auto mb-3 bg-white rounded-full flex items-center justify-center shadow-sm border border-slate-100">
          <span class="text-3xl">ğŸ“</span>
        </div>
        <p class="text-slate-400 text-xs">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ÙˆØµÙ„</p>
      </div>
    </div>
  </div>
  
  <!-- ==================== REGISTER VIEW ==================== -->
  <div id="register-view" class="h-full flex flex-col view-hidden">
    <div class="flex-1 flex flex-col p-6 overflow-auto">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <button onclick="cancelRegistration()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-lg font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
        <div class="w-10 h-10"></div>
      </div>

      <!-- User Type Selection -->
      <div id="reg-type-selection" class="mb-6">
        <p class="text-slate-500 text-sm mb-3">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</p>
        <div class="space-y-3">
          <button onclick="selectRegType('student')" class="w-full py-3 rounded-xl btn-primary text-white font-bold flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            Ø·Ø§Ù„Ø¨ - Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
          </button>
          <button onclick="selectRegType('car-driver')" class="w-full py-3 rounded-xl btn-secondary text-white font-bold flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
            Ø³Ø§Ø¦Ù‚ Ø³ÙŠØ§Ø±Ø© - Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø±Ù…
          </button>
          <button onclick="selectRegType('bus-driver')" class="w-full py-3 rounded-xl btn-amber text-white font-bold flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h8m-8 4h8m-6 4h4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"></path>
            </svg>
            Ø³Ø§Ø¦Ù‚ Ø­Ø§ÙÙ„Ø© - Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø±Ù…
          </button>
        </div>
      </div>

      <!-- QR Scanner for Registration -->
      <div id="reg-qr-section" class="view-hidden">
        <div class="text-center mb-4">
          <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center">
            <span id="reg-qr-icon" class="text-3xl">ğŸ“·</span>
          </div>
          <h2 id="reg-qr-title" class="text-lg font-bold text-slate-800 mb-1">Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
          <p id="reg-qr-subtitle" class="text-slate-500 text-sm">ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø±Ù…Ø² QR Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</p>
        </div>

        <div id="qr-reader" class="rounded-xl overflow-hidden border-2 border-orange-200 mb-4" style="direction: ltr;"></div>

        <div id="qr-scan-status" class="text-center py-2 view-hidden">
          <div class="flex items-center justify-center gap-2">
            <span class="w-2 h-2 rounded-full bg-orange-500 status-live"></span>
            <p class="text-orange-500 text-sm font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...</p>
          </div>
        </div>

        <div id="qr-scan-result" class="gradient-card rounded-lg p-4 view-hidden mb-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-lg">âœ…</span>
            <p class="text-emerald-600 text-sm font-bold">ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</p>
          </div>
          <div id="qr-result-details" class="space-y-2">
            <!-- Populated after scan -->
          </div>
          <button onclick="confirmQrRegistration()" class="w-full py-3 rounded-lg btn-primary text-white font-bold mt-3">
            Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
          </button>
        </div>

        <button onclick="cancelRegistration()" class="w-full py-2 rounded-xl bg-white border border-slate-200 text-slate-500 font-medium text-sm">
          Ø±Ø¬ÙˆØ¹
        </button>
      </div>
    </div>
  </div>
  
  <!-- ==================== LEADERBOARD VIEW ==================== -->
  <div id="leaderboard-view" class="h-full flex flex-col view-hidden">
    <div class="flex-1 flex flex-col p-6 overflow-auto">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <button onclick="showView('login'); resetLoginView();" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        <h1 class="text-lg font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h1>
        <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
          <span class="text-lg">ğŸ†</span>
        </div>
      </div>

      <!-- Top 3 Podium -->
      <div id="leaderboard-podium" class="flex items-end justify-center gap-3 mb-6" style="min-height: 160px;">
        <!-- Populated by JS -->
      </div>

      <!-- Full Leaderboard List -->
      <div class="gradient-card rounded-xl p-4">
        <p class="text-slate-500 text-xs font-bold mb-3">ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</p>
        <div id="leaderboard-list" class="space-y-2">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== STUDENT DASHBOARD ==================== -->
  <div id="student-dashboard-view" class="h-full flex flex-col view-hidden">
    <!-- Top Navigation -->
    <div class="flex items-center justify-between p-4 bg-white/80 border-b border-slate-200 backdrop-blur-md">
      <div class="flex items-center gap-2">
        <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
        <button onclick="toggleMapTheme()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-800 transition-colors" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
          <span class="theme-icon">ğŸŒ™</span>
        </button>
      </div>
      
      <h1 class="text-lg font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
      
      <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
        <span class="text-lg">ğŸ‘¤</span>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="flex gap-2 p-4 bg-slate-50 border-b border-slate-200">
      <button onclick="switchStudentTab('zones')" id="student-tab-zones" class="flex-1 py-2 rounded-lg bg-orange-100 border border-orange-500 text-orange-600 font-medium text-sm">Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</button>
      <button onclick="switchStudentTab('request')" id="student-tab-request" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„</button>
      <button onclick="switchStudentTab('history')" id="student-tab-history" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø§Ù„Ø³Ø¬Ù„</button>
    </div>
    
    <!-- Content -->
    <div class="flex-1 overflow-auto p-4">
      <!-- Zones Tab -->
      <div id="student-zones-tab">
        <p class="text-slate-500 text-sm mb-4">Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§</p>

        <div class="space-y-2 mb-6">
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø©', 1)" class="zone-button w-full">ğŸ­ Ø¨Ø§Ø¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø©</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø©', 2)" class="zone-button w-full">ğŸ¢ Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø©</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ø¹Ø¨', 3)" class="zone-button w-full">âš½ Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ø¹Ø¨</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ…', 4)" class="zone-button w-full">ğŸ”¬ Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ…</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©', 5)" class="zone-button w-full">ğŸ¥ Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø·Ø¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù†', 6)" class="zone-button w-full">ğŸ¦· Ø¨Ø§Ø¨ Ø·Ø¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù†</button>
          <button onclick="selectZone('Ø¨Ø§Ø¨ Ø§Ù„Ø²Ø±Ø§Ø¹Ø©', 7)" class="zone-button w-full">ğŸŒ¾ Ø¨Ø§Ø¨ Ø§Ù„Ø²Ø±Ø§Ø¹Ø©</button>
          <button onclick="selectZone('Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©', 8)" class="zone-button w-full">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</button>
          <button onclick="selectZone('Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ', 9)" class="zone-button w-full">ğŸ“ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ</button>
        </div>
        
        <!-- Selected Zone Info -->
        <div id="selected-zone-info" class="view-hidden gradient-card rounded-lg p-4 mb-4">
          <p class="text-slate-500 text-xs mb-2">Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</p>
          <p id="selected-zone-name" class="text-slate-800 font-bold text-lg mb-3">--</p>
          <p class="text-slate-500 text-xs mb-2">Ù…Ù‚ÙŠÙ‘Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
          <div class="flex items-center gap-2 mb-3">
            <span class="text-yellow-400">â­</span>
            <p id="zone-ai-rating" class="text-slate-800">Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© - ØªÙˆÙØ± Ù†Ù‚Ù„</p>
          </div>
          <button onclick="switchStudentTab('request')" class="w-full py-2 rounded-lg btn-primary text-white font-bold text-sm">Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
        </div>
      </div>
      
      <!-- Request Tab -->
      <div id="student-request-tab" class="view-hidden">
        <div class="mb-4 p-3 rounded-lg bg-blue-500/10 border border-blue-500/30">
          <p class="text-blue-600 text-xs">ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡ØªÙƒ - Ø§Ù„Ø­Ø§ÙÙ„Ø§Øª ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø§Øª ØªØªØ­Ø±Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
        </div>

        <div class="relative">
          <div id="student-map" class="h-96 rounded-lg mb-4 border border-slate-200 z-0"></div>
          <button id="locate-btn" onclick="locateUser()" class="absolute bottom-8 right-4 z-[400] w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-800 hover:bg-slate-100 transition-all border-2 border-slate-200" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">
            <span class="text-2xl">ğŸ“</span>
          </button>
        </div>

        <!-- Live Transport Stats -->
        <div class="gradient-card rounded-lg p-4 mb-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="w-2 h-2 rounded-full bg-orange-500 status-live"></span>
            <p class="text-slate-500 text-xs font-bold">ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</p>
          </div>
          <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="text-center py-2 rounded-lg bg-slate-100">
              <p id="live-bus-count" class="text-lg font-bold text-orange-500">3</p>
              <p class="text-xs text-slate-500">ğŸšŒ Ø­Ø§ÙÙ„Ø§Øª</p>
            </div>
            <div class="text-center py-2 rounded-lg bg-slate-100">
              <p id="live-car-count" class="text-lg font-bold text-amber-500">4</p>
              <p class="text-xs text-slate-500">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª</p>
            </div>
            <div class="text-center py-2 rounded-lg bg-slate-100">
              <p id="live-eta" class="text-lg font-bold text-blue-500">3Ø¯</p>
              <p class="text-xs text-slate-500">Ø£Ù‚Ø±Ø¨ ÙˆØµÙˆÙ„</p>
            </div>
          </div>

          <p class="text-slate-500 text-xs mb-2">Ø§Ù„ÙˆØ¬Ù‡Ø©</p>
          <p id="request-destination" class="text-slate-800 font-bold mb-4">Ø§Ø®ØªØ± ÙˆØ¬Ù‡Ø©</p>

          <button id="request-button" onclick="requestRide()" class="w-full py-3 rounded-lg btn-primary text-white font-bold">
            Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„
          </button>
        </div>

        <!-- AI Insights -->
        <div class="mb-4">
          <p class="text-slate-500 text-xs font-bold mb-2">ğŸ¤– ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
          <div id="student-ai-hints" class="space-y-2">
            <!-- AI hints will be populated here -->
          </div>
        </div>
      </div>
      
      <!-- History Tab -->
      <div id="student-history-tab" class="view-hidden">
        <p class="text-slate-500 text-sm">Ù„Ù… ØªÙ‚Ù… Ø¨Ø±Ø­Ù„Ø§Øª Ø¨Ø¹Ø¯</p>
      </div>
    </div>
  </div>
  
  <!-- ==================== DRIVER DASHBOARD ==================== -->
  <div id="driver-dashboard-view" class="h-full flex flex-col view-hidden">
    <div class="flex items-center justify-between p-4 bg-white/80 border-b border-slate-200 backdrop-blur-md">
      <div class="flex items-center gap-2">
        <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
        <button onclick="toggleMapTheme()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-slate-800 transition-colors" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
          <span class="theme-icon">ğŸŒ™</span>
        </button>
      </div>
      
      <h1 id="driver-title" class="text-lg font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h1>
      
      <div id="driver-points-badge" class="px-3 py-1 rounded-full bg-amber-500/20 border border-amber-500 text-amber-400 text-sm font-bold">
        0 Ù†Ù‚Ø·Ø©
      </div>
    </div>
    
    <div class="flex gap-2 p-4 bg-slate-50 border-b border-slate-200">
      <button onclick="switchDriverTab('map')" id="driver-tab-map" class="flex-1 py-2 rounded-lg bg-orange-100 border border-orange-500 text-orange-600 font-medium text-sm">Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      <button onclick="switchDriverTab('requests')" id="driver-tab-requests" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button onclick="switchDriverTab('profile')" id="driver-tab-profile" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø§Ù„Ù…Ù„Ù</button>
    </div>
    
    <div class="flex-1 overflow-auto">
      <!-- Map Tab -->
      <div id="driver-map-tab" class="h-full flex flex-col">
        <div class="relative flex-1" style="min-height: 350px;">
          <div id="driver-map" class="h-full w-full"></div>
          
          <!-- Driver Navigation Overlay -->
          <div id="driver-nav-overlay" class="absolute top-4 left-4 right-4 z-[400] view-hidden">
            <div class="gradient-card rounded-xl p-4 flex items-center justify-between border border-orange-500/50">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center animate-pulse">
                  <span class="text-xl text-white">â†—ï¸</span>
                </div>
                <div>
                  <p class="text-slate-500 text-xs">Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                  <p id="nav-dist-time" class="text-slate-800 font-bold text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</p>
                </div>
              </div>
              <button onclick="cancelNavigation()" class="px-3 py-1 rounded-lg bg-red-500/10 text-red-500 text-xs border border-red-500/30 font-bold">Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
          </div>

          <button id="driver-locate-btn" onclick="locateDriver()" class="absolute bottom-4 right-4 z-[400] w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-800 hover:bg-slate-100 transition-all border-2 border-slate-200" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">
            <span class="text-2xl">ğŸ“</span>
          </button>
        </div>
        <!-- Driver AI Alert Banner -->
        <div id="driver-ai-alert" class="p-3 bg-gradient-to-r from-red-500/10 to-orange-500/10 border-t border-red-500/30">
          <p class="text-slate-800 font-bold text-xs">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø°ÙƒÙŠ: Ø·Ù„Ø¨ Ø¹Ø§Ù„ÙŠ!</p>
          <p id="driver-alert-text" class="text-slate-600 text-xs">~8 Ø·Ù„Ø§Ø¨ Ù…ØªÙˆÙ‚Ø¹ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø®Ù„Ø§Ù„ 10 Ø¯Ù‚Ø§Ø¦Ù‚</p>
        </div>
        <!-- Driver Stats -->
        <div class="p-3 bg-slate-100 border-t border-slate-200">
          <div class="grid grid-cols-3 gap-2">
            <div class="text-center">
              <p id="driver-nearby-students" class="text-xl font-bold text-blue-500">0</p>
              <p class="text-slate-500 text-xs">Ø·Ù„Ø§Ø¨ Ù‚Ø±ÙŠØ¨ÙˆÙ†</p>
            </div>
            <div class="text-center">
              <p id="driver-active-requests" class="text-xl font-bold text-amber-500">0</p>
              <p class="text-slate-500 text-xs">Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©</p>
            </div>
            <div class="text-center">
              <p id="driver-suggested-route" class="text-xl font-bold text-orange-500">--</p>
              <p class="text-slate-500 text-xs">Ø§Ù„Ù…Ø³Ø§Ø±</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Requests Tab -->
      <div id="driver-requests-tab" class="view-hidden p-4">
        <!-- AI Insights for driver -->
        <div class="mb-4">
          <p class="text-slate-500 text-xs font-bold mb-2">ğŸ¤– ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
          <div id="driver-ai-hints" class="space-y-2">
            <!-- AI hints will be populated here -->
          </div>
        </div>
        <p class="text-slate-500 text-xs font-bold mb-2">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</p>
        <div id="driver-requests-list" class="space-y-3">
          <!-- Requests will be populated here -->
        </div>
      </div>
      
      <!-- Profile Tab -->
      <div id="driver-profile-tab" class="view-hidden p-4">
        <div class="gradient-card rounded-lg p-4 space-y-3">
          <div>
            <p class="text-slate-500 text-xs">Ø§Ù„Ø§Ø³Ù…</p>
            <p id="driver-profile-name" class="text-slate-800 font-bold">--</p>
          </div>
          <div>
            <p class="text-slate-500 text-xs">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</p>
            <p id="driver-profile-email" class="text-slate-800">--</p>
          </div>
          <div>
            <p class="text-slate-500 text-xs">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</p>
            <p id="driver-profile-phone" class="text-slate-800">--</p>
          </div>
          <div id="driver-car-info">
            <p class="text-slate-500 text-xs">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</p>
            <p id="driver-profile-car" class="text-slate-800">--</p>
          </div>
          <div>
            <p class="text-slate-500 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
            <p id="driver-profile-points" class="text-amber-500 font-bold text-lg">0</p>
          </div>
          <div>
            <p class="text-slate-500 text-xs">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
            <p id="driver-profile-rides" class="text-slate-800">0</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==================== ADMIN DASHBOARD ==================== -->
  <div id="admin-dashboard-view" class="h-full flex flex-col view-hidden">
    <div class="flex items-center justify-between p-4 bg-white/80 border-b border-slate-200 backdrop-blur-md">
      <button onclick="handleLogout()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
      </button>
      
      <h1 class="text-lg font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      
      <div class="w-10 h-10"></div>
    </div>
    
    <div class="flex gap-2 p-4 bg-slate-50 border-b border-slate-200">
      <button onclick="switchAdminTab('drivers')" id="admin-tab-drivers" class="flex-1 py-2 rounded-lg bg-orange-100 border border-orange-500 text-orange-600 font-medium text-sm">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ†</button>
      <button onclick="switchAdminTab('rewards')" id="admin-tab-rewards" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</button>
      <button onclick="switchAdminTab('schedule')" id="admin-tab-schedule" class="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-500 font-medium text-sm">Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>
    
    <div class="flex-1 overflow-auto p-4">
      <!-- Drivers Tab -->
      <div id="admin-drivers-tab">
        <!-- Summary Stats -->
        <div class="grid grid-cols-3 gap-2 mb-4">
          <div class="gradient-card rounded-lg p-3 text-center">
            <p id="admin-total-drivers" class="text-xl font-bold text-orange-500">0</p>
            <p class="text-slate-500 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</p>
          </div>
          <div class="gradient-card rounded-lg p-3 text-center">
            <p id="admin-active-drivers" class="text-xl font-bold text-blue-500">0</p>
            <p class="text-slate-500 text-xs">Ù†Ø´Ø·</p>
          </div>
          <div class="gradient-card rounded-lg p-3 text-center">
            <p id="admin-total-rides" class="text-xl font-bold text-amber-500">0</p>
            <p class="text-slate-500 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
          </div>
        </div>
        <p class="text-slate-500 text-xs font-bold mb-2">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</p>
        <div id="admin-drivers-list" class="space-y-3">
          <!-- Drivers will be listed here -->
        </div>
      </div>

      <!-- Rewards Tab -->
      <div id="admin-rewards-tab" class="view-hidden">
        <div class="ai-hint rounded-lg p-3 mb-4">
          <div class="flex items-start gap-2">
            <span class="text-lg">ğŸ†</span>
            <div>
              <p class="text-purple-600 text-xs font-bold">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</p>
              <p class="text-slate-600 text-xs mt-1">Ø§Ø®ØªØ± Ù…ÙƒØ§ÙØ£Ø© Ù„Ù…Ù†Ø­Ù‡Ø§ Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¦Ù‡ ÙˆÙ†Ù‚Ø§Ø·Ù‡</p>
            </div>
          </div>
        </div>
        <div id="admin-rewards-list" class="space-y-3">
          <!-- Reward options -->
        </div>
      </div>

      <!-- Schedule Tab -->
      <div id="admin-schedule-tab" class="view-hidden">
        <div class="ai-hint rounded-lg p-3 mb-4">
          <div class="flex items-start gap-2">
            <span class="text-lg">âš ï¸</span>
            <div>
              <p class="text-purple-600 text-xs font-bold">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°Ø±ÙˆØ©</p>
              <p class="text-slate-600 text-xs mt-1">Ø­Ø¯Ø¯ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¶ØºØ· ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØºØ·ÙŠØ©</p>
            </div>
          </div>
        </div>

        <!-- Add Peak Entry Form -->
        <div class="gradient-card rounded-lg p-4 mb-4">
          <p class="text-slate-800 font-bold text-sm mb-3">Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ø°Ø±ÙˆØ© Ø¬Ø¯ÙŠØ¯</p>
          <div class="space-y-3">
            <div>
              <label class="block text-slate-500 text-xs mb-1">Ø§Ù„ÙŠÙˆÙ…</label>
              <select id="peak-day" class="input-field text-sm">
                <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
                <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
                <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
                <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
                <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-slate-500 text-xs mb-1">ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                <input id="peak-start-time" type="time" class="input-field text-sm" value="08:00">
              </div>
              <div>
                <label class="block text-slate-500 text-xs mb-1">ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                <input id="peak-end-time" type="time" class="input-field text-sm" value="09:30">
              </div>
            </div>
            <div>
              <label class="block text-slate-500 text-xs mb-1">Ù…Ù„Ø§Ø­Ø¸Ø© / Ø§Ù„Ø³Ø¨Ø¨</label>
              <input id="peak-note" type="text" class="input-field text-sm" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù…ØªØ­Ø§Ù† ÙƒÙ„ÙŠØ© Ø§Ù„Ø·Ø¨">
            </div>
            <button onclick="addPeakEntry()" class="w-full py-3 rounded-lg btn-primary text-white font-bold text-sm">
              Ø¥Ø¶Ø§ÙØ© ÙˆÙ‚Øª Ø°Ø±ÙˆØ©
            </button>
          </div>
        </div>

        <!-- Peak Schedule List -->
        <p class="text-slate-500 text-xs font-bold mb-2">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
        <div id="peak-schedule-list" class="space-y-3">
          <!-- Peak entries will be listed here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBNdsQ7SWlbsExJVK_maFlJyaZLkMe859U",
      authDomain: "mosultransport-b2a6b.firebaseapp.com",
      databaseURL: "https://mosultransport-b2a6b-default-rtdb.firebaseio.com",
      projectId: "mosultransport-b2a6b",
      storageBucket: "mosultransport-b2a6b.firebasestorage.app",
      messagingSenderId: "519839855188",
      appId: "1:519839855188:web:dbfbaad5ebe3e91d24f3c1"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const defaultConfig = {
      app_title: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø°ÙƒÙŠ',
      subtitle: 'Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…ÙˆØµÙ„'
    };
    
    let config = { ...defaultConfig };
    const MOSUL_CENTER = [36.383573, 43.139649];
    
    // Current user state
    let currentUser = null;
    let allUsers = [];
    let selectedLoginUserType = null;

    // Zone data
    const zones = [
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ…', id: 1, coords: [36.375655, 43.142223], emoji: 'ğŸ”¬' },
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„Ù…Ù„Ø¹Ø¨', id: 2, coords: [36.378421, 43.139054], emoji: 'âš½' },
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø©', id: 3, coords: [36.376498, 43.142071], emoji: 'ğŸ¢' },
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø©', id: 4, coords: [36.37464, 43.14759], emoji: 'ğŸ­' },
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠØ©', id: 5, coords: [36.390198, 43.144524], emoji: 'ğŸ¥' },
      { name: 'Ø¨Ø§Ø¨ Ø§Ù„Ø²Ø±Ø§Ø¹Ø©', id: 6, coords: [36.388457, 43.146581], emoji: 'ğŸŒ¾' },
      { name: 'Ø¨Ø§Ø¨ Ø·Ø¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù†', id: 7, coords: [36.388068, 43.129247], emoji: 'ğŸ¦·' },
      { name: 'Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠ', id: 8, coords: [36.378329, 43.143835], emoji: 'ğŸ“' },
      { name: 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©', id: 9, coords: [36.378154, 43.144772], emoji: 'ğŸ“š' }
    ];
    
    // Selected zone
    let selectedZone = null;
    let selectedCustomLocation = null;
    let customLocationMarker = null;
    let currentUserLocation = null;
    let userLocationMarker = null;
    let driverLocationMarker = null;
    let studentMap = null;
    let studentTileLayer = null;
    let driverMap = null;
    let driverTileLayer = null;
    let isNightMode = false;
    let onlineDriverMarkers = {};
    let onlineRequestMarkers = {};
    let onlineRequestCircles = {};
    let currentRequestId = null;
    let currentDestination = null;
    let navigationRouteLayer = null;
    let studentRouteLayer = null;
    let activeRequests = {};
    let trackedDriverId = null;
    let trackedRequestLocation = null;
    let lastRouteUpdate = 0;
    let lastRoutePos = null;

    // Simulation state
    let simulationIntervals = [];

    // Bus route data (predefined routes through campus)
    const mainRoadLoop = [
      [36.3746, 43.1475], // Bab Al-Sinaa
      [36.3765, 43.1460], 
      [36.3790, 43.1445], // Student Center area
      [36.3820, 43.1435], 
      [36.3850, 43.1440], // Library
      [36.3880, 43.1460], // Agriculture
      [36.3860, 43.1480], 
      [36.3820, 43.1490], 
      [36.3780, 43.1485]
    ];

    const busRoutes = [
      {
        id: 1, name: 'Ø§Ù„Ø®Ø· Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ',
        points: mainRoadLoop,
        color: '#10b981'
      }
    ];

    // AI hints data
    const aiHintsStudent = [
      { icon: 'ğŸ”®', title: 'ØªÙˆÙ‚Ø¹ Ø°ÙƒÙŠ', text: 'Ø§Ø²Ø¯Ø­Ø§Ù… Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø© Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø© - ÙŠÙÙ†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ…' },
      { icon: 'âš¡', title: 'Ø£Ø³Ø±Ø¹ Ù…Ø³Ø§Ø±', text: 'Ø§Ù„Ø­Ø§ÙÙ„Ø© Ø®Ø· 2 Ù‡ÙŠ Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹ - ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 3 Ø¯Ù‚Ø§Ø¦Ù‚' },
      { icon: 'ğŸ“Š', title: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨', text: 'Ø§Ù„Ø·Ù„Ø¨ Ù…Ù†Ø®ÙØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ - ÙØ±ØµØ© Ø¬ÙŠØ¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹' },
      { icon: 'ğŸŒ¡ï¸', title: 'ØªÙˆÙ‚Ø¹ Ø§Ù„Ø°Ø±ÙˆØ©', text: 'Ø³Ø§Ø¹Ø© Ø§Ù„Ø°Ø±ÙˆØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: 12:30 - ÙŠÙÙ†ØµØ­ Ø¨Ø·Ù„Ø¨ Ø§Ù„ØªÙˆØµÙŠÙ„ Ù‚Ø¨Ù„Ù‡Ø§ Ø¨Ù€10 Ø¯Ù‚Ø§Ø¦Ù‚' },
      { icon: 'ğŸ¯', title: 'Ø§Ù‚ØªØ±Ø§Ø­ Ø°ÙƒÙŠ', text: 'Ø±Ø­Ù„Ø© Ù…Ø´ØªØ±ÙƒØ© Ù…ØªØ§Ø­Ø© Ù…Ø¹ 2 Ø·Ù„Ø§Ø¨ Ø¢Ø®Ø±ÙŠÙ† Ù„Ù†ÙØ³ Ø§Ù„ÙˆØ¬Ù‡Ø© - Ø³Ø±Ø¹Ø© Ø£Ø¹Ù„Ù‰' }
    ];

    const aiHintsDriver = [
      { icon: 'ğŸ”¥', title: 'Ù…Ù†Ø·Ù‚Ø© Ø·Ù„Ø¨ Ø¹Ø§Ù„ÙŠ', text: 'Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø© - ~12 Ø·Ø§Ù„Ø¨ ÙŠÙ†ØªØ¸Ø±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹' },
      { icon: 'ğŸ“ˆ', title: 'ØªÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨', text: 'Ù…ØªÙˆÙ‚Ø¹ Ø²ÙŠØ§Ø¯Ø© 40% ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø®Ù„Ø§Ù„ 20 Ø¯Ù‚ÙŠÙ‚Ø©' },
      { icon: 'ğŸ›£ï¸', title: 'Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ù…Ø«Ù„', text: 'Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: Ø¨Ø§Ø¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø© â† Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø§Ø³Ø© â† Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©' },
      { icon: 'â°', title: 'ØªÙ†Ø¨ÙŠÙ‡ Ø°Ø±ÙˆØ©', text: 'Ø³Ø§Ø¹Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª 12:30 - ØªÙˆØ¬Ù‡ Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø¹Ù„ÙˆÙ… Ù„Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ø·Ù„Ø§Ø¨' },
      { icon: 'ğŸ’¡', title: 'Ù†ØµÙŠØ­Ø© Ø°ÙƒÙŠØ©', text: 'Ù…Ù†Ø·Ù‚Ø© Ø¨Ø§Ø¨ Ø·Ø¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù† Ø¨Ù‡Ø§ Ø£Ù‚Ù„ ØªØºØ·ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ - ÙØ±ØµØ© Ù„Ù†Ù‚Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ©' }
    ];

    // Dummy drivers for admin panel
    const dummyDrivers = [
      { name: 'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', user_type: 'bus-driver', car_model: 'Mercedes Sprinter 2021', car_plate: '1234 MOZ', phone: '07701234567', points: 285, rides: 42, status: 'active' },
      { name: 'Ø³Ø§Ø±Ø© Ø®Ø§Ù„Ø¯', user_type: 'car-driver', car_model: 'Toyota Corolla 2020', car_plate: '5678 NIN', phone: '07702345678', points: 210, rides: 31, status: 'active' },
      { name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†', user_type: 'bus-driver', car_model: 'Hyundai County 2019', car_plate: '9012 MOZ', phone: '07703456789', points: 175, rides: 28, status: 'active' },
      { name: 'ÙØ§Ø·Ù…Ø© Ø¹Ù…Ø±', user_type: 'car-driver', car_model: 'Kia Cerato 2022', car_plate: '3456 NIN', phone: '07704567890', points: 150, rides: 22, status: 'inactive' },
      { name: 'Ø¹Ù„ÙŠ Ù…Ø­Ù…ÙˆØ¯', user_type: 'bus-driver', car_model: 'Isuzu Journey 2020', car_plate: '7890 MOZ', phone: '07705678901', points: 130, rides: 19, status: 'active' },
      { name: 'Ø²ÙŠÙ†Ø¨ Ø£Ø­Ù…Ø¯', user_type: 'car-driver', car_model: 'Hyundai Elantra 2021', car_plate: '2345 NIN', phone: '07706789012', points: 95, rides: 14, status: 'active' },
      { name: 'Ø­Ø³Ù† Ø¬Ø§Ø³Ù…', user_type: 'car-driver', car_model: 'Toyota Yaris 2019', car_plate: '6789 NIN', phone: '07707890123', points: 60, rides: 9, status: 'inactive' },
      { name: 'Ù…Ø±ÙŠÙ… Ù†Ø§ØµØ±', user_type: 'bus-driver', car_model: 'Mercedes Vito 2022', car_plate: '0123 MOZ', phone: '07708901234', points: 45, rides: 6, status: 'active' }
    ];

    // Peak schedule entries
    let peakScheduleEntries = [
      { day: 'Ø§Ù„Ø£Ø­Ø¯', time: '08:00', endTime: '09:30', note: 'Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ØµØ¨Ø§Ø­ÙŠ' },
      { day: 'Ø§Ù„Ø£Ø­Ø¯', time: '12:30', endTime: '13:30', note: 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©' },
      { day: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', time: '14:00', endTime: '15:00', note: 'Ø§Ù…ØªØ­Ø§Ù† ÙƒÙ„ÙŠØ© Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©' }
    ];
    
    // ==================== THEME MANAGEMENT ====================
    
    function toggleMapTheme() {
      isNightMode = !isNightMode;
      const icon = isNightMode ? 'â˜€ï¸' : 'ğŸŒ™';
      document.querySelectorAll('.theme-icon').forEach(el => el.textContent = icon);
      
      if (studentMap) refreshMapLayer(studentMap, 'student');
      if (driverMap) refreshMapLayer(driverMap, 'driver');
    }

    function createBaseLayer() {
      return L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles Â© Esri',
        maxZoom: 19
      });
    }

    function refreshMapLayer(map, type) {
      if (type === 'student' && studentTileLayer) map.removeLayer(studentTileLayer);
      if (type === 'driver' && driverTileLayer) map.removeLayer(driverTileLayer);
      
      const layer = createBaseLayer();
      layer.addTo(map);
      layer.bringToBack();
      
      if (type === 'student') studentTileLayer = layer;
      if (type === 'driver') driverTileLayer = layer;
    }

    // ==================== SDK INITIALIZATION ====================
    
    const dataHandler = {
      onDataChanged(data) {
        allUsers = data;
      }
    };
    
    async function initDataSDK() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }
    }
    
    // ==================== VIEW MANAGEMENT ====================

    function showView(viewName) {
      // Clean up simulations when switching views
      stopAllSimulations();

      document.querySelectorAll('[id$="-view"]').forEach(view => {
        view.classList.add('view-hidden');
      });

      const targetView = document.getElementById(`${viewName}-view`);
      if (targetView) {
        targetView.classList.remove('view-hidden');
      }
    }

    function stopAllSimulations() {
      simulationIntervals.forEach(interval => clearInterval(interval));
      simulationIntervals = [];
    }

    // ==================== SIMULATION UTILITIES ====================

    function getRandomPosition(center, range) {
      return [
        center[0] + (Math.random() - 0.5) * range,
        center[1] + (Math.random() - 0.5) * range
      ];
    }

    function createCustomIcon(type, size) {
      const colors = {
        student: { bg: '#3b82f6', emoji: 'ğŸ‘¤' },
        bus: { bg: '#f97316', emoji: 'ğŸšŒ' },
        car: { bg: '#f59e0b', emoji: 'ğŸš—' },
        you: { bg: '#ef4444', emoji: 'ğŸ“' }
      };
      const c = colors[type] || colors.student;
      return L.divIcon({
        html: '<div style="width:' + size + 'px;height:' + size + 'px;background:' + c.bg + ';border-radius:50%;border:3px solid white;box-shadow:0 4px 15px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:' + (size * 0.5) + 'px;">' + c.emoji + '</div>',
        className: '',
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2]
      });
    }

    function populateAIHints(containerId, hints) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      // Show 2-3 random hints
      const shuffled = [...hints].sort(() => Math.random() - 0.5).slice(0, 3);
      shuffled.forEach(hint => {
        const div = document.createElement('div');
        div.className = 'ai-hint rounded-lg p-3';
        div.innerHTML = '<div class="flex items-start gap-2"><span class="text-lg">' + hint.icon + '</span><div><p class="text-purple-600 text-xs font-bold">' + hint.title + '</p><p class="text-slate-600 text-xs mt-1">' + hint.text + '</p></div></div>';
        container.appendChild(div);
      });
    }

    // ==================== AUTHENTICATION ====================

    let html5QrCode = null;
    let qrScannedData = null;
    let selectedRegType = null;

    function selectLoginUserType(type) {
      selectedLoginUserType = type;
      document.getElementById('login-user-type-selection').classList.add('view-hidden');
      document.getElementById('login-form').classList.remove('view-hidden');
    }

    function resetLoginView() {
      selectedLoginUserType = null;
      document.getElementById('login-user-type-selection').classList.remove('view-hidden');
      document.getElementById('login-form').classList.add('view-hidden');
      document.getElementById('login-email').value = '';
    }

    // ==================== QR SCANNER (REGISTRATION) ====================

    function selectRegType(type) {
      selectedRegType = type;
      document.getElementById('reg-type-selection').classList.add('view-hidden');
      document.getElementById('reg-qr-section').classList.remove('view-hidden');

      if (type === 'student') {
        document.getElementById('reg-qr-title').textContent = 'Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨';
        document.getElementById('reg-qr-subtitle').textContent = 'ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø±Ù…Ø² QR Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨';
        document.getElementById('reg-qr-icon').textContent = 'ğŸ“';
      } else {
        document.getElementById('reg-qr-title').textContent = 'Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø±Ù…';
        document.getElementById('reg-qr-subtitle').textContent = 'ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø±Ù…Ø² QR Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø±Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ';
        document.getElementById('reg-qr-icon').textContent = 'ğŸš—';
      }

      startQrScanner();
    }

    function cancelRegistration() {
      stopQrScanner();
      qrScannedData = null;
      selectedRegType = null;
      showView('login');
      resetLoginView();
    }

    function startQrScanner() {
      document.getElementById('qr-scan-status').classList.remove('view-hidden');
      document.getElementById('qr-scan-result').classList.add('view-hidden');
      qrScannedData = null;

      html5QrCode = new Html5Qrcode('qr-reader');
      html5QrCode.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onQrCodeSuccess,
        onQrCodeError
      ).catch(err => {
        console.error('QR Scanner Error:', err);
        document.getElementById('qr-scan-status').classList.add('view-hidden');
        showManualQrFallback();
      });
    }

    function stopQrScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          html5QrCode = null;
        }).catch(err => {
          console.error('Stop scanner error:', err);
          html5QrCode = null;
        });
      }
    }

    function showManualQrFallback() {
      const readerEl = document.getElementById('qr-reader');
      const placeholder = selectedRegType === 'student'
        ? '{"name":"Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ","email":"ahmed@uomosul.edu.iq","student_id":"2024001","gender":"male","age":21}'
        : '{"name":"Ø³Ø§Ø±Ø© Ø®Ø§Ù„Ø¯","email":"sara@uomosul.edu.iq","phone":"07702345678","car_model":"Toyota 2020","car_plate":"1234 MOS","driver_license":"DL-5678"}';
      readerEl.innerHTML =
        '<div class="p-6 text-center">' +
          '<p class="text-slate-500 text-sm mb-3">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª QR ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</p>' +
          '<textarea id="manual-qr-input" class="input-field text-sm" rows="4" dir="ltr" placeholder=\'' + placeholder + '\'></textarea>' +
          '<button onclick="processManualQr()" class="w-full py-2 rounded-lg btn-primary text-white font-bold text-sm mt-3">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>' +
        '</div>';
    }

    function processManualQr() {
      const input = document.getElementById('manual-qr-input').value.trim();
      if (input) {
        onQrCodeSuccess(input);
      }
    }

    function onQrCodeSuccess(decodedText) {
      stopQrScanner();
      document.getElementById('qr-scan-status').classList.add('view-hidden');

      try {
        const data = JSON.parse(decodedText);
        qrScannedData = data;
        displayQrResult(data);
      } catch (e) {
        qrScannedData = { raw: decodedText };
        displayQrResultFromId(decodedText);
      }
    }

    function onQrCodeError(errorMessage) {
      // Silent - scanning continues
    }

    function displayQrResult(data) {
      const detailsEl = document.getElementById('qr-result-details');
      detailsEl.innerHTML = '';

      const fields = [];

      if (selectedRegType === 'student') {
        fields.push(
          { label: 'Ø§Ù„Ø§Ø³Ù…', value: data.name || '--' },
          { label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', value: data.email || '--' },
          { label: 'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ', value: data.student_id || '--' },
          { label: 'Ø§Ù„Ø¬Ù†Ø³', value: data.gender === 'male' ? 'Ø°ÙƒØ±' : data.gender === 'female' ? 'Ø£Ù†Ø«Ù‰' : '--' },
          { label: 'Ø§Ù„Ø¹Ù…Ø±', value: data.age || '--' }
        );
        if (data.disability && data.disability !== 'Ù„Ø§ ØªÙˆØ¬Ø¯') {
          fields.push({ label: 'Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©', value: data.disability });
        }
      } else {
        fields.push(
          { label: 'Ø§Ù„Ø§Ø³Ù…', value: data.name || '--' },
          { label: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', value: data.email || '--' },
          { label: 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', value: data.phone || '--' },
          { label: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', value: selectedRegType === 'bus-driver' ? 'Ø­Ø§ÙÙ„Ø©' : 'Ø³ÙŠØ§Ø±Ø©' },
          { label: 'Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©', value: data.car_model || '--' },
          { label: 'Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©', value: data.car_plate || '--' },
          { label: 'Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©', value: data.driver_license || '--' }
        );
      }

      fields.forEach(f => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center';
        row.innerHTML = '<span class="text-slate-500 text-xs">' + f.label + '</span><span class="text-slate-800 text-sm font-bold">' + f.value + '</span>';
        detailsEl.appendChild(row);
      });

      document.getElementById('qr-scan-result').classList.remove('view-hidden');
    }

    function displayQrResultFromId(rawText) {
      if (selectedRegType === 'student') {
        qrScannedData = {
          name: 'Ø·Ø§Ù„Ø¨ #' + rawText,
          email: rawText + '@uomosul.edu.iq',
          student_id: rawText,
          gender: 'male',
          age: 21
        };
      } else {
        qrScannedData = {
          name: 'Ø³Ø§Ø¦Ù‚ #' + rawText,
          email: rawText + '@uomosul.edu.iq',
          phone: '07701234567',
          car_model: selectedRegType === 'bus-driver' ? 'Mercedes Sprinter 2021' : 'Toyota Corolla 2020',
          car_plate: rawText,
          driver_license: 'DL-' + rawText
        };
      }

      displayQrResult(qrScannedData);
    }

    function confirmQrRegistration() {
      if (!qrScannedData || !selectedRegType) return;

      const userData = {
        user_id: qrScannedData.student_id || qrScannedData.driver_license || Date.now().toString(),
        user_type: selectedRegType,
        name: qrScannedData.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
        email: qrScannedData.email || '',
        phone: qrScannedData.phone || '',
        points: 0,
        rides: 0
      };

      if (selectedRegType === 'student') {
        userData.gender = qrScannedData.gender || '';
        userData.age = qrScannedData.age || 0;
        userData.disability = qrScannedData.disability || 'Ù„Ø§ ØªÙˆØ¬Ø¯';
        userData.student_id = qrScannedData.student_id || '';
      } else {
        userData.car_model = qrScannedData.car_model || '';
        userData.car_plate = qrScannedData.car_plate || '';
        userData.driver_license = qrScannedData.driver_license || '';
      }

      // Save to Data SDK if available
      if (window.dataSdk) {
        window.dataSdk.create(userData).then(result => {
          if (result.isOk) {
            alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + result.error.message);
          }
        });
      } else {
        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©)');
      }

      // Go back to login
      stopQrScanner();
      qrScannedData = null;
      selectedRegType = null;
      showView('login');
      resetLoginView();
    }

    function handleLogin() {
      const email = document.getElementById('login-email').value.trim();

      if (!email) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
        return;
      }

      if (!selectedLoginUserType) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return;
      }

      // Create a dummy user for testing
      currentUser = {
        user_id: Date.now().toString(),
        user_type: selectedLoginUserType,
        name: 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ',
        email: email,
        phone: '07701234567',
        points: Math.floor(Math.random() * 100),
        rides: Math.floor(Math.random() * 20)
      };

      // Add dummy data based on user type
      if (selectedLoginUserType === 'car-driver' || selectedLoginUserType === 'bus-driver') {
        currentUser.car_model = 'Toyota 2020';
        currentUser.car_plate = '1234 ABC';
        currentUser.driver_license = 'DL-' + Date.now();
      }

      // Navigate to appropriate dashboard
      if (selectedLoginUserType === 'student') {
        showView('student-dashboard');
        initStudentDashboard();
      } else if (selectedLoginUserType === 'car-driver' || selectedLoginUserType === 'bus-driver') {
        showView('driver-dashboard');
        initDriverDashboard();
      } else if (selectedLoginUserType === 'admin') {
        showView('admin-dashboard');
        initAdminDashboard();
      }
    }

    function handleLogout() {
      stopQrScanner();
      qrScannedData = null;
      selectedRegType = null;
      currentUser = null;
      selectedZone = null;
      selectedCustomLocation = null;
      selectedLoginUserType = null;
      stopAllSimulations();
      if (customLocationMarker && studentMap) {
        studentMap.removeLayer(customLocationMarker);
        customLocationMarker = null;
      }
      showView('login');
      resetLoginView();
    }
    
    // ==================== STUDENT DASHBOARD ====================
    
    function initStudentDashboard() {
      switchStudentTab('zones');
    }
    
    function switchStudentTab(tab) {
      document.getElementById('student-zones-tab').classList.add('view-hidden');
      document.getElementById('student-request-tab').classList.add('view-hidden');
      document.getElementById('student-history-tab').classList.add('view-hidden');
      
      document.getElementById('student-tab-zones').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('student-tab-request').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('student-tab-history').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      
      document.getElementById('student-tab-zones').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('student-tab-request').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('student-tab-history').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      
      if (tab === 'zones') {
        document.getElementById('student-zones-tab').classList.remove('view-hidden');
        document.getElementById('student-tab-zones').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('student-tab-zones').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
      } else if (tab === 'request') {
        document.getElementById('student-request-tab').classList.remove('view-hidden');
        document.getElementById('student-tab-request').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('student-tab-request').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
        setTimeout(() => initStudentMap(), 100);
      } else if (tab === 'history') {
        document.getElementById('student-history-tab').classList.remove('view-hidden');
        document.getElementById('student-tab-history').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('student-tab-history').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
      }
    }
    
    function selectZone(zoneName, zoneId) {
      selectedZone = zones.find(z => z.id === zoneId);
      selectedCustomLocation = null;

      document.querySelectorAll('.zone-button').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.zone-button').classList.add('active');

      document.getElementById('selected-zone-info').classList.remove('view-hidden');
      document.getElementById('selected-zone-name').textContent = zoneName;
      document.getElementById('zone-ai-rating').textContent = 'â­ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© - ØªÙˆÙØ± Ù†Ù‚Ù„ - Ù…Ø³Ø§ÙØ©: ' + Math.floor(Math.random() * 5 + 1) + ' ÙƒÙ…';
      document.getElementById('request-destination').textContent = zoneName;

      // Remove custom marker if exists
      if (customLocationMarker && studentMap) {
        studentMap.removeLayer(customLocationMarker);
        customLocationMarker = null;
      }
    }
    
    function initStudentMap() {
      if (studentMap) {
        studentMap.remove();
        studentMap = null;
      }
      stopAllSimulations();
      simBusMarkers = [];
      simCarMarkers = [];
      busRouteLines = [];
      onlineDriverMarkers = {};

      const mapContainer = document.getElementById('student-map');
      if (!mapContainer) return;

      studentMap = L.map('student-map', {
        zoomControl: false
      }).setView(MOSUL_CENTER, 15);

      // Base layer
      studentTileLayer = createBaseLayer().addTo(studentMap);

      // Roads and labels overlay
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        opacity: 0.6
      }).addTo(studentMap);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        opacity: 0.8
      }).addTo(studentMap);

      // Add zone markers
      zones.forEach(zone => {
        L.marker(zone.coords, {
          icon: L.divIcon({
            html: '<div style="font-size: 18px;">' + zone.emoji + '</div>',
            className: 'zone-marker',
            iconSize: [30, 30]
          })
        }).addTo(studentMap);
      });

      // Listen for Real-Time Drivers
      db.ref('drivers').on('value', (snapshot) => {
        const drivers = snapshot.val() || {};
        
        // Remove old markers
        Object.keys(onlineDriverMarkers).forEach(key => {
          if (!drivers[key]) {
            studentMap.removeLayer(onlineDriverMarkers[key]);
            delete onlineDriverMarkers[key];
          }
        });

        // Update/Add markers
        Object.keys(drivers).forEach(key => {
          const driver = drivers[key];
          if (onlineDriverMarkers[key]) {
            onlineDriverMarkers[key].setLatLng([driver.lat, driver.lng]);
            // Update Student Route if this is the tracked driver
            if (trackedDriverId === key && trackedRequestLocation) {
               updateNavigationRoute(driver.lat, driver.lng, trackedRequestLocation[0], trackedRequestLocation[1], studentMap, false);
            }
          } else {
            const marker = L.marker([driver.lat, driver.lng], {
              icon: createCustomIcon(driver.user_type === 'bus-driver' ? 'bus' : 'car', 38)
            }).addTo(studentMap);
            marker.bindPopup(`<div style="direction:rtl;text-align:right;"><b>${driver.user_type === 'bus-driver' ? 'ğŸšŒ' : 'ğŸš—'} ${driver.name}</b><br><span style="font-size:11px;">${driver.car_model}</span></div>`);
            onlineDriverMarkers[key] = marker;
          }
        });
        
        // Update stats
        const busCount = Object.values(drivers).filter(d => d.user_type === 'bus-driver').length;
        const carCount = Object.values(drivers).filter(d => d.user_type === 'car-driver').length;
        if(document.getElementById('live-bus-count')) document.getElementById('live-bus-count').textContent = busCount;
        if(document.getElementById('live-car-count')) document.getElementById('live-car-count').textContent = carCount;
      });

      // Add click handler for custom location selection
      studentMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if (customLocationMarker) {
          studentMap.removeLayer(customLocationMarker);
        }

        customLocationMarker = L.marker([lat, lng], {
          icon: L.divIcon({
            html: '<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 50%; border: 4px solid white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5); animation: bounce 0.5s;">ğŸ“</div>',
            className: '',
            iconSize: [40, 40]
          })
        }).addTo(studentMap);

        selectedCustomLocation = { lat, lng };
        selectedZone = null;

        document.querySelectorAll('.zone-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('selected-zone-info').classList.remove('view-hidden');
        document.getElementById('selected-zone-name').textContent = 'Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ (' + lat.toFixed(4) + ', ' + lng.toFixed(4) + ')';
        document.getElementById('zone-ai-rating').textContent = 'ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©';
        document.getElementById('request-destination').textContent = 'Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ';
      });

      // Populate AI hints
      populateAIHints('student-ai-hints', aiHintsStudent);
    }

    async function getRealRoute(startLat, startLng, endLat, endLng) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
        const response = await fetch(url);
        if (!response.ok) return null;
        const data = await response.json();
        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
          return data.routes[0];
        }
        return null;
      } catch (e) {
        console.error('OSRM Error:', e);
        return null;
      }
    }
    
    function locateUser() {
      if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ');
        return;
      }

      const btn = document.getElementById('locate-btn');
      if (btn) {
        btn.innerHTML = '<span class="animate-spin">â†»</span>';
        btn.disabled = true;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          if (btn) {
            btn.innerHTML = '<span class="text-2xl">â—</span>';
            btn.disabled = false;
          }
          
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          currentUserLocation = [lat, lng];

          if (studentMap) {
            studentMap.flyTo([lat, lng], 18);

            // Remove existing user marker
            if (userLocationMarker) {
              studentMap.removeLayer(userLocationMarker);
            }

            // Add You marker
            userLocationMarker = L.marker([lat, lng], {
              icon: L.divIcon({
                html: '<div class="pulse-marker" style="width:20px;height:20px;background:#3b82f6;border-radius:50%;border:3px solid white;box-shadow:0 0 15px #3b82f6;"></div>',
                className: '',
                iconSize: [20, 20]
              })
            }).addTo(studentMap);
            
            // Add accuracy circle
            L.circle([lat, lng], {
              radius: accuracy,
              color: '#3b82f6',
              fillColor: '#3b82f6',
              fillOpacity: 0.15,
              weight: 1
            }).addTo(studentMap);

            userLocationMarker.bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯Ù‚Ø© ' + Math.round(accuracy) + ' Ù…ØªØ±)').openPopup();
          }

          // Update state
          
          // Update UI
          document.querySelectorAll('.zone-button').forEach(btn => btn.classList.remove('active'));
          document.getElementById('selected-zone-info').classList.remove('view-hidden');
          document.getElementById('selected-zone-name').textContent = 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)';
          document.getElementById('zone-ai-rating').textContent = 'ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©';
          document.getElementById('request-destination').textContent = 'Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ';
        },
        (error) => {
          if (btn) {
            btn.innerHTML = '<span class="text-2xl">ğŸ“</span>';
            btn.disabled = false;
          }
          console.error(error);
          alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…");
        },
        { enableHighAccuracy: true }
      );
    }

    // Helper to calculate bearing between two points for rotation
    function getBearing(startLat, startLng, destLat, destLng) {
      const toRad = (deg) => deg * (Math.PI / 180);
      const toDeg = (rad) => rad * (180 / Math.PI);
      
      const y = Math.sin(toRad(destLng) - toRad(startLng)) * Math.cos(toRad(destLat));
      const x = Math.cos(toRad(startLat)) * Math.sin(toRad(destLat)) -
            Math.sin(toRad(startLat)) * Math.cos(toRad(destLat)) * Math.cos(toRad(destLng) - toRad(startLng));
      let brng = Math.atan2(y, x);
      return (toDeg(brng) + 360) % 360;
    }

    function animateBus(routeCoordinates) {
      if (!studentMap || !routeCoordinates || routeCoordinates.length === 0) return;

      // Convert [lng, lat] to [lat, lng]
      const pathPoints = routeCoordinates.map(c => [c[1], c[0]]);
      
      // Spawn Bus at Start
      const startPos = pathPoints[0];
      const busMarker = L.marker(startPos, {
        icon: createCustomIcon('bus', 40)
      }).addTo(studentMap);
      
      let i = 0;
      const interval = setInterval(() => {
        if (i >= pathPoints.length - 1) {
          clearInterval(interval);
          busMarker.bindPopup('ÙˆØµÙ„Øª Ø§Ù„Ø­Ø§ÙÙ„Ø©!').openPopup();
          return;
        }
        
        const currentPos = pathPoints[i];
        const nextPos = pathPoints[i+1];
        
        // Move marker
        busMarker.setLatLng(currentPos);
        
        // Rotate marker (Visual Trick)
        const bearing = getBearing(currentPos[0], currentPos[1], nextPos[0], nextPos[1]);
        const el = busMarker.getElement();
        if (el && el.firstChild) {
          // Adjust rotation (Bus emoji ğŸšŒ usually faces left, so we adjust by 90 or 180 deg if needed)
          // Assuming standard bearing (0 is North). 
          el.firstChild.style.transition = 'transform 0.05s linear';
          el.firstChild.style.transform = `rotate(${bearing - 90}deg)`; 
        }
        
        i++;
      }, 50); // 50ms update rate
      
      simulationIntervals.push(interval);
    }

    async function getSmartRoute(start, end) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
          return data.routes[0];
        }
        return null;
      } catch (e) {
        console.error('OSRM Error:', e);
        return null;
      }
    }

    async function drawRouteOnMap(map, start, end, isDriver = false) {
      map.eachLayer(layer => {
        if (layer.options && layer.options.className === 'smart-route') map.removeLayer(layer);
      });

      const route = await getSmartRoute(start, end);
      if (route) {
        L.geoJSON(route.geometry, {
          style: { color: '#f97316', weight: 5, dashArray: '10, 10', opacity: 0.8, className: 'smart-route' }
        }).addTo(map);
        
        if (!isDriver) {
          const mins = Math.round(route.duration / 60);
          const etaEl = document.getElementById('live-eta');
          if (etaEl) etaEl.textContent = mins + 'Ø¯';
        }
      }
    }

    async function updateNavigationRoute(startLat, startLng, endLat, endLng, mapInstance, isDriver = true) {
      // Clear existing layer first to prevent ghost lines
      if (isDriver) {
        if (navigationRouteLayer) mapInstance.removeLayer(navigationRouteLayer);
        navigationRouteLayer = null;
      } else {
        if (studentRouteLayer) mapInstance.removeLayer(studentRouteLayer);
        studentRouteLayer = null;
      }

      try {
        // OSRM expects {lng},{lat}
        const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
        
        // Add timeout to fail fast
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('OSRM API Error');

        const data = await response.json();
        
        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          const layer = L.geoJSON(route.geometry, {
            style: { color: '#f97316', weight: 6, opacity: 0.9, lineCap: 'round' }
          }).addTo(mapInstance);
          
          if (isDriver) {
            navigationRouteLayer = layer;
            // Update Overlay
            const mins = Math.round(route.duration / 60);
            const km = (route.distance / 1000).toFixed(1);
            const navEl = document.getElementById('nav-dist-time');
            if (navEl) navEl.textContent = `${mins} Ø¯Ù‚ÙŠÙ‚Ø© â€¢ ${km} ÙƒÙ…`;
          } else {
            studentRouteLayer = layer;
          }
          return; // Success
        }
      } catch (e) {
        console.error('Navigation Error (Using Fallback):', e);
      }

      // Fallback: Straight Dashed Line
      const fallbackLayer = L.polyline([[startLat, startLng], [endLat, endLng]], {
        color: '#f97316',
        weight: 5,
        dashArray: '10, 10',
        opacity: 0.7
      }).addTo(mapInstance);

      if (isDriver) {
        navigationRouteLayer = fallbackLayer;
        const navEl = document.getElementById('nav-dist-time');
        if (navEl) navEl.textContent = `Ù…Ø³Ø§Ø± Ù…Ø¨Ø§Ø´Ø±`;
      } else {
        studentRouteLayer = fallbackLayer;
      }
    }

    async function requestRide() {
      if (!currentUserLocation) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ğŸ“');
        return;
      }

      if (!selectedZone && !selectedCustomLocation) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹ - Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø©');
        return;
      }

      const btn = document.getElementById('request-button');
      btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';
      btn.disabled = true;

      // Draw Route for Student
      const startPos = currentUserLocation;
      const endPos = selectedZone ? selectedZone.coords : [selectedCustomLocation.lat, selectedCustomLocation.lng];
      if (studentMap) {
        drawRouteOnMap(studentMap, startPos, endPos);
      }

      // Push Request to Firebase
      const requestData = {
        user_id: currentUser.user_id,
        name: currentUser.name,
        location: selectedZone ? selectedZone.coords : [selectedCustomLocation.lat, selectedCustomLocation.lng],
        destination: selectedZone ? selectedZone.name : 'Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ',
        timestamp: Date.now(),
        status: 'pending'
      };

      const newReqRef = db.ref('ride_requests').push();
      currentRequestId = newReqRef.key;

      newReqRef.set(requestData).then(() => {
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚...';
        
        // Listen for driver acceptance
        db.ref('ride_requests/' + currentRequestId).on('value', (snapshot) => {
          const data = snapshot.val();
          if (data && data.status === 'accepted') {
            btn.textContent = `ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„: ${data.driver_name} âœ“`;
            btn.classList.add('bg-emerald-600');
            
            // Start Tracking for Student
            trackedDriverId = data.driver_id;
            trackedRequestLocation = data.location;
            
            // Initial Draw if driver location is known
            if (onlineDriverMarkers[trackedDriverId]) {
               const dPos = onlineDriverMarkers[trackedDriverId].getLatLng();
               updateNavigationRoute(dPos.lat, dPos.lng, trackedRequestLocation[0], trackedRequestLocation[1], studentMap, false);
            }
            
            alert(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ${data.driver_name}! ğŸš—`);
          }
        });
      });
    }
    
    function locateDriver() {
      if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ');
        return;
      }

      const btn = document.getElementById('driver-locate-btn');
      if (btn) {
        btn.innerHTML = '<span class="animate-spin">â†»</span>';
        btn.disabled = true;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          if (btn) {
            btn.innerHTML = '<span class="text-2xl">ğŸ“</span>';
            btn.disabled = false;
          }
          
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;

          if (driverMap) {
            driverMap.flyTo([lat, lng], 18);

            // Remove existing marker
            if (driverLocationMarker) {
              driverMap.removeLayer(driverLocationMarker);
            }

            // Add Driver marker
            driverLocationMarker = L.marker([lat, lng], {
              icon: createCustomIcon(currentUser.user_type === 'bus-driver' ? 'bus' : 'car', 44)
            }).addTo(driverMap);
            
            // Add accuracy circle
            L.circle([lat, lng], {
              radius: accuracy,
              color: '#10b981',
              fillColor: '#10b981',
              fillOpacity: 0.15,
              weight: 1
            }).addTo(driverMap);

            driverLocationMarker.bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();
          }
        },
        (error) => {
          if (btn) {
            btn.innerHTML = '<span class="text-2xl">ğŸ“</span>';
            btn.disabled = false;
          }
          console.error(error);
          alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ");
        },
        { enableHighAccuracy: true }
      );
    }

    // ==================== DRIVER DASHBOARD ====================
    
    function initDriverDashboard() {
      document.getElementById('driver-profile-name').textContent = currentUser.name;
      document.getElementById('driver-profile-email').textContent = currentUser.email;
      document.getElementById('driver-profile-phone').textContent = currentUser.phone;
      document.getElementById('driver-profile-points').textContent = currentUser.points || 0;
      document.getElementById('driver-profile-rides').textContent = currentUser.rides || 0;
      document.getElementById('driver-points-badge').textContent = (currentUser.points || 0) + ' Ù†Ù‚Ø·Ø©';
      
      if (currentUser.user_type === 'car-driver') {
        document.getElementById('driver-car-info').innerHTML = `
          <p class="text-slate-400 text-xs">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</p>
          <p class="text-white">${currentUser.car_model} - ${currentUser.car_plate}</p>
        `;
        document.getElementById('driver-title').textContent = 'Ù„ÙˆØ­Ø© Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø©';
      } else {
        document.getElementById('driver-car-info').innerHTML = `
          <p class="text-slate-400 text-xs">Ø§Ù„Ø­Ø§ÙÙ„Ø©</p>
          <p class="text-white">${currentUser.car_model} - ${currentUser.car_plate}</p>
        `;
        document.getElementById('driver-title').textContent = 'Ù„ÙˆØ­Ø© Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§ÙÙ„Ø©';
      }
      
      switchDriverTab('map');
    }
    
    function switchDriverTab(tab) {
      document.getElementById('driver-map-tab').classList.add('view-hidden');
      document.getElementById('driver-requests-tab').classList.add('view-hidden');
      document.getElementById('driver-profile-tab').classList.add('view-hidden');
      
      document.getElementById('driver-tab-map').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('driver-tab-requests').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('driver-tab-profile').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      
      document.getElementById('driver-tab-map').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('driver-tab-requests').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('driver-tab-profile').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      
      if (tab === 'map') {
        document.getElementById('driver-map-tab').classList.remove('view-hidden');
        document.getElementById('driver-tab-map').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('driver-tab-map').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
        setTimeout(() => initDriverMap(), 100);
      } else if (tab === 'requests') {
        document.getElementById('driver-requests-tab').classList.remove('view-hidden');
        document.getElementById('driver-tab-requests').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('driver-tab-requests').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
      } else if (tab === 'profile') {
        document.getElementById('driver-profile-tab').classList.remove('view-hidden');
        document.getElementById('driver-tab-profile').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('driver-tab-profile').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
      }
    }
    
    function initDriverMap() {
      if (driverMap) {
        driverMap.remove();
        driverMap = null;
      }
      driverLocationMarker = null;
      stopAllSimulations();
      simStudentMarkers = [];
      onlineRequestMarkers = {};
      onlineRequestCircles = {};
      currentDestination = null;
      if (navigationRouteLayer && driverMap) {
        driverMap.removeLayer(navigationRouteLayer);
        navigationRouteLayer = null;
      }

      const mapContainer = document.getElementById('driver-map');
      if (!mapContainer) return;

      driverMap = L.map('driver-map', {
        zoomControl: false
      }).setView(MOSUL_CENTER, 15);

      // Base layer
      driverTileLayer = createBaseLayer().addTo(driverMap);

      // Roads and labels overlay
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        opacity: 0.6
      }).addTo(driverMap);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        opacity: 0.8
      }).addTo(driverMap);

      // Add zone markers
      zones.forEach(zone => {
        L.marker(zone.coords, {
          icon: L.divIcon({
            html: '<div style="font-size: 16px;">' + zone.emoji + '</div>',
            className: 'zone-marker',
            iconSize: [30, 30]
          })
        }).addTo(driverMap);
      });

      // Add driver's own position marker
      driverLocationMarker = L.marker(MOSUL_CENTER, {
        icon: createCustomIcon(currentUser.user_type === 'bus-driver' ? 'bus' : 'car', 44)
      }).addTo(driverMap);

      // Add "you are here" pulse ring
      L.circle(MOSUL_CENTER, {
        radius: 40,
        color: currentUser.user_type === 'bus-driver' ? '#10b981' : '#f59e0b',
        fillColor: currentUser.user_type === 'bus-driver' ? '#10b981' : '#f59e0b',
        fillOpacity: 0.15,
        weight: 2
      }).addTo(driverMap);

      // Listen for Ride Requests
      db.ref('ride_requests').on('value', (snapshot) => {
        const requests = snapshot.val() || {};
        activeRequests = requests;
        const list = document.getElementById('driver-requests-list');
        if (list) list.innerHTML = '';
        
        // Remove old markers
        Object.keys(onlineRequestMarkers).forEach(key => {
          if (!requests[key] || requests[key].status !== 'pending') {
            driverMap.removeLayer(onlineRequestMarkers[key]);
            delete onlineRequestMarkers[key];
            if (onlineRequestCircles[key]) {
              driverMap.removeLayer(onlineRequestCircles[key]);
              delete onlineRequestCircles[key];
            }
          }
        });

        let activeCount = 0;
        Object.keys(requests).forEach(key => {
          const req = requests[key];
          if (req.status !== 'pending') return;
          activeCount++;
          
          // Add Marker
          if (!onlineRequestMarkers[key]) {
            const marker = L.marker(req.location, {
              icon: createCustomIcon('student', 28)
            }).addTo(driverMap);
            marker.bindPopup(`<div style="direction:rtl;text-align:right;"><b>ğŸ‘¤ ${req.name}</b><br><span style="font-size:11px;">Ø§Ù„ÙˆØ¬Ù‡Ø©: ${req.destination}</span></div>`);
            onlineRequestMarkers[key] = marker;
            
            const circle = L.circle(req.location, {
              color: '#ef4444',
              fillColor: '#ef4444',
              fillOpacity: 0.2,
              radius: 50
            }).addTo(driverMap);
            onlineRequestCircles[key] = circle;
          }
          
          // Add to List
          if (list) {
            const minutes = Math.floor((Date.now() - req.timestamp) / 60000);
            const card = document.createElement('div');
            card.className = 'gradient-card rounded-lg p-3';
            card.innerHTML =
              `<div class="flex items-center justify-between mb-2">
                <div><p class="text-slate-800 font-bold text-sm">ğŸ‘¤ ${req.name}</p>
                <p class="text-slate-500 text-xs">Ø§Ù„ÙˆØ¬Ù‡Ø©: ${req.destination}</p></div>
                <p class="text-slate-500 text-xs">Ù…Ù†Ø° ${minutes} Ø¯</p>
              </div>
              <div class="flex gap-2">
                <button onclick="acceptRide('${key}')" class="flex-1 py-2 rounded-lg btn-primary text-white text-xs font-bold">Ù‚Ø¨ÙˆÙ„</button>
              </div>`;
            list.appendChild(card);
          }
        });
        
        const alertText = document.getElementById('driver-alert-text');
        if (alertText) {
          alertText.innerHTML = `ğŸ”¥ Heatmap: ${activeCount} Students Waiting`;
        }
        if(document.getElementById('driver-active-requests')) document.getElementById('driver-active-requests').textContent = activeCount;
        if(document.getElementById('driver-nearby-students')) document.getElementById('driver-nearby-students').textContent = activeCount;
      });

      // Start driver online mode
      startDriverOnlineMode();
    }

    function startDriverOnlineMode() {
      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          if (driverLocationMarker) driverLocationMarker.setLatLng([lat, lng]);
          
          // Update Navigation if active (Throttled)
          if (currentDestination) {
            const now = Date.now();
            const currentPos = L.latLng(lat, lng);
            const dist = lastRoutePos ? currentPos.distanceTo(lastRoutePos) : 9999;

            // Update only if > 4 seconds passed OR moved > 20 meters
            if (now - lastRouteUpdate > 4000 || dist > 20) {
              updateNavigationRoute(lat, lng, currentDestination.lat, currentDestination.lng, driverMap, true);
              lastRouteUpdate = now;
              lastRoutePos = currentPos;
            }
          }
          
          // Update Firebase
          db.ref('drivers/' + currentUser.user_id).set({
            name: currentUser.name,
            user_type: currentUser.user_type,
            car_model: currentUser.car_model,
            lat: lat,
            lng: lng,
            timestamp: Date.now()
          });
        }, null, { enableHighAccuracy: true });
      }

      // Populate driver AI hints and requests
      populateAIHints('driver-ai-hints', aiHintsDriver);
    }
    
    function acceptRide(key) {
      const req = activeRequests[key];
      if (req && driverLocationMarker) {
        // 1. Store Destination
        currentDestination = { lat: req.location[0], lng: req.location[1] };
        
        // 2. Start Navigation
        const driverPos = driverLocationMarker.getLatLng();
        updateNavigationRoute(driverPos.lat, driverPos.lng, currentDestination.lat, currentDestination.lng, driverMap, true);
        
        // Show Overlay
        document.getElementById('driver-nav-overlay').classList.remove('view-hidden');
      }

      db.ref('ride_requests/' + key).update({
        status: 'accepted',
        driver_id: currentUser.user_id,
        driver_name: currentUser.name
      }).then(() => {
        alert('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø©...');
        switchDriverTab('map');
      });
    }

    function cancelNavigation() {
      currentDestination = null;
      if (navigationRouteLayer && driverMap) {
        driverMap.removeLayer(navigationRouteLayer);
      }
      document.getElementById('driver-nav-overlay').classList.add('view-hidden');
    }

    
    // ==================== LEADERBOARD ====================

    function initLeaderboard() {
      const sorted = [...dummyDrivers].sort((a, b) => b.points - a.points);

      // Podium (top 3)
      const podium = document.getElementById('leaderboard-podium');
      podium.innerHTML = '';

      const podiumOrder = [1, 0, 2]; // 2nd, 1st, 3rd for visual layout
      const podiumColors = ['from-yellow-400 to-amber-500', 'from-gray-300 to-gray-400', 'from-amber-600 to-amber-700'];
      const podiumHeights = ['h-28', 'h-36', 'h-24'];
      const podiumEmojis = ['ğŸ¥ˆ', 'ğŸ¥‡', 'ğŸ¥‰'];
      const podiumTextSizes = ['text-sm', 'text-base', 'text-sm'];

      podiumOrder.forEach((rank, i) => {
        if (!sorted[rank]) return;
        const driver = sorted[rank];
        const typeIcon = driver.user_type === 'bus-driver' ? 'ğŸšŒ' : 'ğŸš—';
        const col = document.createElement('div');
        col.className = 'flex flex-col items-center flex-1';
        col.innerHTML =
          '<p class="text-2xl mb-1">' + podiumEmojis[i] + '</p>' +
          '<p class="' + podiumTextSizes[i] + ' font-bold text-slate-800 mb-1 text-center">' + driver.name + '</p>' +
          '<p class="text-xs text-slate-500 mb-2">' + typeIcon + ' ' + driver.points + ' Ù†Ù‚Ø·Ø©</p>' +
          '<div class="w-full ' + podiumHeights[i] + ' rounded-t-xl bg-gradient-to-b ' + podiumColors[i] + ' flex items-end justify-center pb-2">' +
            '<span class="text-white font-bold text-lg">' + driver.points + '</span>' +
          '</div>';
        podium.appendChild(col);
      });

      // Full list
      const list = document.getElementById('leaderboard-list');
      list.innerHTML = '';

      sorted.forEach((driver, index) => {
        const rankEmoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
        const typeIcon = driver.user_type === 'bus-driver' ? 'ğŸšŒ' : 'ğŸš—';
        const statusDot = driver.status === 'active' ? 'bg-emerald-400' : 'bg-red-400';

        const row = document.createElement('div');
        row.className = 'flex items-center justify-between py-3 border-b border-slate-100 last:border-0';
        row.innerHTML =
          '<div class="flex items-center gap-3">' +
            '<span class="w-8 text-center font-bold text-lg ' + (index < 3 ? 'text-amber-500' : 'text-slate-400') + '">' + rankEmoji + '</span>' +
            '<div>' +
              '<p class="text-slate-800 font-bold text-sm">' + driver.name + '</p>' +
              '<p class="text-slate-500 text-xs">' + typeIcon + ' ' + driver.car_model + ' &bull; ' + driver.rides + ' Ø±Ø­Ù„Ø©</p>' +
            '</div>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
            '<div class="text-left">' +
              '<p class="text-amber-500 font-bold">' + driver.points + '</p>' +
              '<p class="text-slate-400 text-xs">Ù†Ù‚Ø·Ø©</p>' +
            '</div>' +
            '<span class="w-2 h-2 rounded-full ' + statusDot + '"></span>' +
          '</div>';
        list.appendChild(row);
      });
    }

    // ==================== ADMIN DASHBOARD ====================

    function initAdminDashboard() {
      switchAdminTab('drivers');
      populateAdminDriversList();
    }

    function switchAdminTab(tab) {
      document.getElementById('admin-drivers-tab').classList.add('view-hidden');
      document.getElementById('admin-rewards-tab').classList.add('view-hidden');
      document.getElementById('admin-schedule-tab').classList.add('view-hidden');

      document.getElementById('admin-tab-drivers').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('admin-tab-rewards').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');
      document.getElementById('admin-tab-schedule').classList.remove('bg-orange-100', 'border-orange-500', 'text-orange-600');

      document.getElementById('admin-tab-drivers').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('admin-tab-rewards').classList.add('bg-white', 'border-slate-200', 'text-slate-500');
      document.getElementById('admin-tab-schedule').classList.add('bg-white', 'border-slate-200', 'text-slate-500');

      if (tab === 'drivers') {
        document.getElementById('admin-drivers-tab').classList.remove('view-hidden');
        document.getElementById('admin-tab-drivers').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('admin-tab-drivers').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
      } else if (tab === 'rewards') {
        document.getElementById('admin-rewards-tab').classList.remove('view-hidden');
        document.getElementById('admin-tab-rewards').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('admin-tab-rewards').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
        populateRewardsList();
      } else if (tab === 'schedule') {
        document.getElementById('admin-schedule-tab').classList.remove('view-hidden');
        document.getElementById('admin-tab-schedule').classList.remove('bg-white', 'border-slate-200', 'text-slate-500');
        document.getElementById('admin-tab-schedule').classList.add('bg-orange-100', 'border-orange-500', 'text-orange-600');
        renderPeakSchedule();
      }
    }

    function populateAdminDriversList() {
      const list = document.getElementById('admin-drivers-list');
      list.innerHTML = '';

      // Update summary stats
      const totalDrivers = dummyDrivers.length;
      const activeDrivers = dummyDrivers.filter(d => d.status === 'active').length;
      const totalRides = dummyDrivers.reduce((sum, d) => sum + d.rides, 0);
      document.getElementById('admin-total-drivers').textContent = totalDrivers;
      document.getElementById('admin-active-drivers').textContent = activeDrivers;
      document.getElementById('admin-total-rides').textContent = totalRides;

      // Sort by points descending
      const sorted = [...dummyDrivers].sort((a, b) => b.points - a.points);

      sorted.forEach((driver, index) => {
        const rankEmoji = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        const statusColor = driver.status === 'active' ? 'text-emerald-400' : 'text-red-400';
        const statusText = driver.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';
        const typeIcon = driver.user_type === 'bus-driver' ? 'ğŸšŒ' : 'ğŸš—';

        const card = document.createElement('div');
        card.className = 'gradient-card rounded-lg p-3';
        card.innerHTML =
          '<div class="flex items-center justify-between mb-2">' +
            '<div class="flex items-center gap-2">' +
              (rankEmoji ? '<span class="text-lg">' + rankEmoji + '</span>' : '') +
              '<div>' +
                '<p class="text-slate-800 font-bold text-sm">' + driver.name + '</p>' +
                '<p class="text-slate-500 text-xs">' + typeIcon + ' ' + driver.car_model + '</p>' +
              '</div>' +
            '</div>' +
            '<div class="text-left">' +
              '<p class="text-amber-500 font-bold text-lg">' + driver.points + '</p>' +
              '<p class="text-slate-500 text-xs">Ù†Ù‚Ø·Ø©</p>' +
            '</div>' +
          '</div>' +
          '<div class="flex items-center justify-between">' +
            '<div class="flex items-center gap-3">' +
              '<span class="text-slate-500 text-xs">' + driver.car_plate + '</span>' +
              '<span class="text-slate-500 text-xs">ğŸ“ ' + driver.phone + '</span>' +
            '</div>' +
            '<div class="flex items-center gap-2">' +
              '<span class="text-slate-400 text-xs">' + driver.rides + ' Ø±Ø­Ù„Ø©</span>' +
              '<span class="w-2 h-2 rounded-full ' + (driver.status === 'active' ? 'bg-emerald-400' : 'bg-red-400') + '"></span>' +
              '<span class="' + statusColor + ' text-xs">' + statusText + '</span>' +
            '</div>' +
          '</div>';
        list.appendChild(card);
      });
    }

    function populateRewardsList() {
      const list = document.getElementById('admin-rewards-list');
      list.innerHTML = '';

      const rewards = [
        { name: 'ÙƒØªØ§Ø¨ Ø´ÙƒØ±', icon: 'ğŸ“œ', color: 'emerald' },
        { name: 'Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù…Ù„ ØªØ·ÙˆØ¹ÙŠ', icon: 'ğŸ–ï¸', color: 'blue' },        
      ];

      // Sort by points descending
      const sorted = [...dummyDrivers].sort((a, b) => b.points - a.points);

      sorted.forEach((driver) => {
        const rankLabel = driver.points >= 200 ? 'â­ Ù…ØªÙ…ÙŠØ²' : driver.points >= 100 ? 'âœ… Ø¬ÙŠØ¯' : 'ğŸ“Š Ù…Ø¨ØªØ¯Ø¦';
        const typeIcon = driver.user_type === 'bus-driver' ? 'ğŸšŒ' : 'ğŸš—';
        const card = document.createElement('div');
        card.className = 'gradient-card rounded-lg p-3';
        card.innerHTML =
          '<div class="flex items-center justify-between mb-3">' +
            '<div>' +
              '<p class="text-slate-800 font-bold text-sm">' + typeIcon + ' ' + driver.name + '</p>' +
              '<p class="text-slate-500 text-xs">' + driver.points + ' Ù†Ù‚Ø·Ø© - ' + driver.rides + ' Ø±Ø­Ù„Ø©</p>' +
            '</div>' +
            '<span class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">' + rankLabel + '</span>' +
          '</div>' +
          '<div class="flex gap-2">' +
            rewards.map(function(reward) {
              return '<button onclick="giveReward(\'' + driver.name + '\', \'' + reward.name + '\')" class="flex-1 py-2 rounded-lg bg-' + reward.color + '-500/20 border border-' + reward.color + '-500/50 text-' + reward.color + '-400 text-xs font-medium hover:bg-' + reward.color + '-500/30">' +
                reward.icon + ' ' + reward.name +
              '</button>';
            }).join('') +
          '</div>';
        list.appendChild(card);
      });
    }

    function giveReward(driverName, reward) {
      alert('ØªÙ… Ù…Ù†Ø­ "' + driverName + '" ' + reward + ' Ø¨Ù†Ø¬Ø§Ø­!');
    }

    function addPeakEntry() {
      const day = document.getElementById('peak-day').value;
      const startTime = document.getElementById('peak-start-time').value;
      const endTime = document.getElementById('peak-end-time').value;
      const note = document.getElementById('peak-note').value.trim();

      if (!startTime || !endTime) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
      }

      if (!note) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø°Ø±ÙˆØ©');
        return;
      }

      peakScheduleEntries.push({ day, time: startTime, endTime, note });

      // Clear form
      document.getElementById('peak-note').value = '';

      renderPeakSchedule();
    }

    function removePeakEntry(index) {
      peakScheduleEntries.splice(index, 1);
      renderPeakSchedule();
    }

    function renderPeakSchedule() {
      const list = document.getElementById('peak-schedule-list');
      if (!list) return;
      list.innerHTML = '';

      if (peakScheduleEntries.length === 0) {
        list.innerHTML = '<p class="text-slate-500 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª Ø°Ø±ÙˆØ© Ù…Ø³Ø¬Ù„Ø©</p>';
        return;
      }

      // Group entries by day
      const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³'];
      const grouped = {};
      peakScheduleEntries.forEach((entry, i) => {
        if (!grouped[entry.day]) grouped[entry.day] = [];
        grouped[entry.day].push({ ...entry, originalIndex: i });
      });

      days.forEach(day => {
        if (!grouped[day]) return;
        const dayEntries = grouped[day];

        const daySection = document.createElement('div');
        daySection.className = 'mb-3';
        daySection.innerHTML = '<p class="text-orange-500 text-xs font-bold mb-2">ğŸ“… ' + day + '</p>';

        dayEntries.forEach(entry => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'gradient-card rounded-lg p-3 mb-2 flex items-center justify-between';
          entryDiv.innerHTML =
            '<div class="flex-1">' +
              '<div class="flex items-center gap-2 mb-1">' +
                '<span class="text-red-400 text-xs font-bold">ğŸ”´ ' + entry.time + ' - ' + entry.endTime + '</span>' +
              '</div>' +
              '<p class="text-slate-600 text-xs">' + entry.note + '</p>' +
            '</div>' +
            '<button onclick="removePeakEntry(' + entry.originalIndex + ')" class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 hover:bg-red-500/30">' +
              '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>' +
            '</button>';
          daySection.appendChild(entryDiv);
        });

        list.appendChild(daySection);
      });
    }
    
    // ==================== ELEMENT SDK ====================
    
    async function onConfigChange(newConfig) {
      config = { ...config, ...newConfig };
    }
    
    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }
    
    function mapToEditPanelValues(config) {
      return new Map([
        ['app_title', config.app_title || defaultConfig.app_title],
        ['subtitle', config.subtitle || defaultConfig.subtitle]
      ]);
    }
    
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
    
    // Initialize
    initDataSDK();
    showView('login');
  </script>
</body>
</html>
